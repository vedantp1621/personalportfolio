{"ast":null,"code":"import BRDF_Lambert from './BSDF/BRDF_Lambert.js';\nimport BRDF_GGX from './BSDF/BRDF_GGX.js';\nimport DFGApprox from './BSDF/DFGApprox.js';\nimport EnvironmentBRDF from './BSDF/EnvironmentBRDF.js';\nimport F_Schlick from './BSDF/F_Schlick.js';\nimport Schlick_to_F0 from './BSDF/Schlick_to_F0.js';\nimport BRDF_Sheen from './BSDF/BRDF_Sheen.js';\nimport LightingModel from '../core/LightingModel.js';\nimport { diffuseColor, specularColor, roughness, clearcoat, clearcoatRoughness, sheen, sheenRoughness, iridescence, iridescenceIOR, iridescenceThickness } from '../core/PropertyNode.js';\nimport { transformedNormalView, transformedClearcoatNormalView } from '../accessors/NormalNode.js';\nimport { positionViewDirection } from '../accessors/PositionNode.js';\nimport { tslFn, float, vec3, mat3 } from '../shadernode/ShaderNode.js';\nimport { cond } from '../math/CondNode.js';\nimport { mix, smoothstep } from '../math/MathNode.js';\n\n//\n// Iridescence\n//\n\n// XYZ to linear-sRGB color space\nconst XYZ_TO_REC709 = mat3(3.2404542, -0.9692660, 0.0556434, -1.5371385, 1.8760108, -0.2040259, -0.4985314, 0.0415560, 1.0572252);\n\n// Assume air interface for top\n// Note: We don't handle the case fresnel0 == 1\nconst Fresnel0ToIor = fresnel0 => {\n  const sqrtF0 = fresnel0.sqrt();\n  return vec3(1.0).add(sqrtF0).div(vec3(1.0).sub(sqrtF0));\n};\n\n// ior is a value between 1.0 and 3.0. 1.0 is air interface\nconst IorToFresnel0 = (transmittedIor, incidentIor) => {\n  return transmittedIor.sub(incidentIor).div(transmittedIor.add(incidentIor)).pow2();\n};\n\n// Fresnel equations for dielectric/dielectric interfaces.\n// Ref: https://belcour.github.io/blog/research/2017/05/01/brdf-thin-film.html\n// Evaluation XYZ sensitivity curves in Fourier space\nconst evalSensitivity = (OPD, shift) => {\n  const phase = OPD.mul(2.0 * Math.PI * 1.0e-9);\n  const val = vec3(5.4856e-13, 4.4201e-13, 5.2481e-13);\n  const pos = vec3(1.6810e+06, 1.7953e+06, 2.2084e+06);\n  const VAR = vec3(4.3278e+09, 9.3046e+09, 6.6121e+09);\n  const x = float(9.7470e-14 * Math.sqrt(2.0 * Math.PI * 4.5282e+09)).mul(phase.mul(2.2399e+06).add(shift.x).cos()).mul(phase.pow2().mul(-4.5282e+09).exp());\n  let xyz = val.mul(VAR.mul(2.0 * Math.PI).sqrt()).mul(pos.mul(phase).add(shift).cos()).mul(phase.pow2().negate().mul(VAR).exp());\n  xyz = vec3(xyz.x.add(x), xyz.y, xyz.z).div(1.0685e-7);\n  const rgb = XYZ_TO_REC709.mul(xyz);\n  return rgb;\n};\nconst evalIridescence = tslFn(_ref => {\n  let {\n    outsideIOR,\n    eta2,\n    cosTheta1,\n    thinFilmThickness,\n    baseF0\n  } = _ref;\n  // Force iridescenceIOR -> outsideIOR when thinFilmThickness -> 0.0\n  const iridescenceIOR = mix(outsideIOR, eta2, smoothstep(0.0, 0.03, thinFilmThickness));\n  // Evaluate the cosTheta on the base layer (Snell law)\n  const sinTheta2Sq = outsideIOR.div(iridescenceIOR).pow2().mul(float(1).sub(cosTheta1.pow2()));\n\n  // Handle TIR:\n  const cosTheta2Sq = float(1).sub(sinTheta2Sq);\n  /*if ( cosTheta2Sq < 0.0 ) {\n  \t\t\treturn vec3( 1.0 );\n  \t}*/\n\n  const cosTheta2 = cosTheta2Sq.sqrt();\n\n  // First interface\n  const R0 = IorToFresnel0(iridescenceIOR, outsideIOR);\n  const R12 = F_Schlick({\n    f0: R0,\n    f90: 1.0,\n    dotVH: cosTheta1\n  });\n  //const R21 = R12;\n  const T121 = R12.oneMinus();\n  const phi12 = iridescenceIOR.lessThan(outsideIOR).cond(Math.PI, 0.0);\n  const phi21 = float(Math.PI).sub(phi12);\n\n  // Second interface\n  const baseIOR = Fresnel0ToIor(baseF0.clamp(0.0, 0.9999)); // guard against 1.0\n  const R1 = IorToFresnel0(baseIOR, iridescenceIOR.vec3());\n  const R23 = F_Schlick({\n    f0: R1,\n    f90: 1.0,\n    dotVH: cosTheta2\n  });\n  const phi23 = vec3(baseIOR.x.lessThan(iridescenceIOR).cond(Math.PI, 0.0), baseIOR.y.lessThan(iridescenceIOR).cond(Math.PI, 0.0), baseIOR.z.lessThan(iridescenceIOR).cond(Math.PI, 0.0));\n\n  // Phase shift\n  const OPD = iridescenceIOR.mul(thinFilmThickness, cosTheta2, 2.0);\n  const phi = vec3(phi21).add(phi23);\n\n  // Compound terms\n  const R123 = R12.mul(R23).clamp(1e-5, 0.9999);\n  const r123 = R123.sqrt();\n  const Rs = T121.pow2().mul(R23).div(vec3(1.0).sub(R123));\n\n  // Reflectance term for m = 0 (DC term amplitude)\n  const C0 = R12.add(Rs);\n  let I = C0;\n\n  // Reflectance term for m > 0 (pairs of diracs)\n  let Cm = Rs.sub(T121);\n  for (let m = 1; m <= 2; ++m) {\n    Cm = Cm.mul(r123);\n    const Sm = evalSensitivity(float(m).mul(OPD), float(m).mul(phi)).mul(2.0);\n    I = I.add(Cm.mul(Sm));\n  }\n\n  // Since out of gamut colors might be produced, negative color values are clamped to 0.\n  return I.max(vec3(0.0));\n}).setLayout({\n  name: 'evalIridescence',\n  type: 'vec3',\n  inputs: [{\n    name: 'outsideIOR',\n    type: 'float'\n  }, {\n    name: 'eta2',\n    type: 'float'\n  }, {\n    name: 'cosTheta1',\n    type: 'float'\n  }, {\n    name: 'thinFilmThickness',\n    type: 'float'\n  }, {\n    name: 'baseF0',\n    type: 'vec3'\n  }]\n});\n\n//\n//\tSheen\n//\n\n// This is a curve-fit approxmation to the \"Charlie sheen\" BRDF integrated over the hemisphere from\n// Estevez and Kulla 2017, \"Production Friendly Microfacet Sheen BRDF\". The analysis can be found\n// in the Sheen section of https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\nconst IBLSheenBRDF = tslFn(_ref2 => {\n  let {\n    normal,\n    viewDir,\n    roughness\n  } = _ref2;\n  const dotNV = normal.dot(viewDir).saturate();\n  const r2 = roughness.pow2();\n  const a = cond(roughness.lessThan(0.25), float(-339.2).mul(r2).add(float(161.4).mul(roughness)).sub(25.9), float(-8.48).mul(r2).add(float(14.3).mul(roughness)).sub(9.95));\n  const b = cond(roughness.lessThan(0.25), float(44.0).mul(r2).sub(float(23.7).mul(roughness)).add(3.26), float(1.97).mul(r2).sub(float(3.27).mul(roughness)).add(0.72));\n  const DG = cond(roughness.lessThan(0.25), 0.0, float(0.1).mul(roughness).sub(0.025)).add(a.mul(dotNV).add(b).exp());\n  return DG.mul(1.0 / Math.PI).saturate();\n});\nconst clearcoatF0 = vec3(0.04);\nconst clearcoatF90 = vec3(1);\n\n//\n\nclass PhysicalLightingModel extends LightingModel {\n  constructor() {\n    let clearcoat = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : false;\n    let sheen = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    let iridescence = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;\n    super();\n    this.clearcoat = clearcoat;\n    this.sheen = sheen;\n    this.iridescence = iridescence;\n    this.clearcoatRadiance = null;\n    this.clearcoatSpecularDirect = null;\n    this.clearcoatSpecularIndirect = null;\n    this.sheenSpecularDirect = null;\n    this.sheenSpecularIndirect = null;\n    this.iridescenceFresnel = null;\n    this.iridescenceF0 = null;\n  }\n  start( /*context*/\n  ) {\n    if (this.clearcoat === true) {\n      this.clearcoatRadiance = vec3().temp('clearcoatRadiance');\n      this.clearcoatSpecularDirect = vec3().temp('clearcoatSpecularDirect');\n      this.clearcoatSpecularIndirect = vec3().temp('clearcoatSpecularIndirect');\n    }\n    if (this.sheen === true) {\n      this.sheenSpecularDirect = vec3().temp('sheenSpecularDirect');\n      this.sheenSpecularIndirect = vec3().temp('sheenSpecularIndirect');\n    }\n    if (this.iridescence === true) {\n      const dotNVi = transformedNormalView.dot(positionViewDirection).clamp();\n      this.iridescenceFresnel = evalIridescence({\n        outsideIOR: float(1.0),\n        eta2: iridescenceIOR,\n        cosTheta1: dotNVi,\n        thinFilmThickness: iridescenceThickness,\n        baseF0: specularColor\n      });\n      this.iridescenceF0 = Schlick_to_F0({\n        f: this.iridescenceFresnel,\n        f90: 1.0,\n        dotVH: dotNVi\n      });\n    }\n  }\n\n  // Fdez-AgÃ¼era's \"Multiple-Scattering Microfacet Model for Real-Time Image Based Lighting\"\n  // Approximates multiscattering in order to preserve energy.\n  // http://www.jcgt.org/published/0008/01/03/\n\n  computeMultiscattering(singleScatter, multiScatter) {\n    let specularF90 = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : float(1);\n    const dotNV = transformedNormalView.dot(positionViewDirection).clamp(); // @ TODO: Move to core dotNV\n\n    const fab = DFGApprox({\n      roughness,\n      dotNV\n    });\n    const Fr = this.iridescenceF0 ? iridescence.mix(specularColor, this.iridescenceF0) : specularColor;\n    const FssEss = Fr.mul(fab.x).add(specularF90.mul(fab.y));\n    const Ess = fab.x.add(fab.y);\n    const Ems = Ess.oneMinus();\n    const Favg = specularColor.add(specularColor.oneMinus().mul(0.047619)); // 1/21\n    const Fms = FssEss.mul(Favg).div(Ems.mul(Favg).oneMinus());\n    singleScatter.addAssign(FssEss);\n    multiScatter.addAssign(Fms.mul(Ems));\n  }\n  direct(_ref3) {\n    let {\n      lightDirection,\n      lightColor,\n      reflectedLight\n    } = _ref3;\n    const dotNL = transformedNormalView.dot(lightDirection).clamp();\n    const irradiance = dotNL.mul(lightColor);\n    if (this.sheen === true) {\n      this.sheenSpecularDirect.addAssign(irradiance.mul(BRDF_Sheen({\n        lightDirection\n      })));\n    }\n    if (this.clearcoat === true) {\n      const dotNLcc = transformedClearcoatNormalView.dot(lightDirection).clamp();\n      const ccIrradiance = dotNLcc.mul(lightColor);\n      this.clearcoatSpecularDirect.addAssign(ccIrradiance.mul(BRDF_GGX({\n        lightDirection,\n        f0: clearcoatF0,\n        f90: clearcoatF90,\n        roughness: clearcoatRoughness,\n        normalView: transformedClearcoatNormalView\n      })));\n    }\n    reflectedLight.directDiffuse.addAssign(irradiance.mul(BRDF_Lambert({\n      diffuseColor: diffuseColor.rgb\n    })));\n    reflectedLight.directSpecular.addAssign(irradiance.mul(BRDF_GGX({\n      lightDirection,\n      f0: specularColor,\n      f90: 1,\n      roughness,\n      iridescence: this.iridescence,\n      iridescenceFresnel: this.iridescenceFresnel\n    })));\n  }\n  indirectDiffuse(_ref4) {\n    let {\n      irradiance,\n      reflectedLight\n    } = _ref4;\n    reflectedLight.indirectDiffuse.addAssign(irradiance.mul(BRDF_Lambert({\n      diffuseColor\n    })));\n  }\n  indirectSpecular(_ref5) {\n    let {\n      radiance,\n      iblIrradiance,\n      reflectedLight\n    } = _ref5;\n    if (this.sheen === true) {\n      this.sheenSpecularIndirect.addAssign(iblIrradiance.mul(sheen, IBLSheenBRDF({\n        normal: transformedNormalView,\n        viewDir: positionViewDirection,\n        roughness: sheenRoughness\n      })));\n    }\n    if (this.clearcoat === true) {\n      const dotNVcc = transformedClearcoatNormalView.dot(positionViewDirection).clamp();\n      const clearcoatEnv = EnvironmentBRDF({\n        dotNV: dotNVcc,\n        specularColor: clearcoatF0,\n        specularF90: clearcoatF90,\n        roughness: clearcoatRoughness\n      });\n      this.clearcoatSpecularIndirect.addAssign(this.clearcoatRadiance.mul(clearcoatEnv));\n    }\n\n    // Both indirect specular and indirect diffuse light accumulate here\n\n    const singleScattering = vec3().temp('singleScattering');\n    const multiScattering = vec3().temp('multiScattering');\n    const cosineWeightedIrradiance = iblIrradiance.mul(1 / Math.PI);\n    this.computeMultiscattering(singleScattering, multiScattering);\n    const totalScattering = singleScattering.add(multiScattering);\n    const diffuse = diffuseColor.mul(totalScattering.r.max(totalScattering.g).max(totalScattering.b).oneMinus());\n    reflectedLight.indirectSpecular.addAssign(radiance.mul(singleScattering));\n    reflectedLight.indirectSpecular.addAssign(multiScattering.mul(cosineWeightedIrradiance));\n    reflectedLight.indirectDiffuse.addAssign(diffuse.mul(cosineWeightedIrradiance));\n  }\n  ambientOcclusion(_ref6) {\n    let {\n      ambientOcclusion,\n      reflectedLight\n    } = _ref6;\n    const dotNV = transformedNormalView.dot(positionViewDirection).clamp(); // @ TODO: Move to core dotNV\n\n    const aoNV = dotNV.add(ambientOcclusion);\n    const aoExp = roughness.mul(-16.0).oneMinus().negate().exp2();\n    const aoNode = ambientOcclusion.sub(aoNV.pow(aoExp).oneMinus()).clamp();\n    if (this.clearcoat === true) {\n      this.clearcoatSpecularIndirect.mulAssign(ambientOcclusion);\n    }\n    if (this.sheen === true) {\n      this.sheenSpecularIndirect.mulAssign(ambientOcclusion);\n    }\n    reflectedLight.indirectDiffuse.mulAssign(ambientOcclusion);\n    reflectedLight.indirectSpecular.mulAssign(aoNode);\n  }\n  finish(context) {\n    const {\n      outgoingLight\n    } = context;\n    if (this.clearcoat === true) {\n      const dotNVcc = transformedClearcoatNormalView.dot(positionViewDirection).clamp();\n      const Fcc = F_Schlick({\n        dotVH: dotNVcc,\n        f0: clearcoatF0,\n        f90: clearcoatF90\n      });\n      const clearcoatLight = outgoingLight.mul(clearcoat.mul(Fcc).oneMinus()).add(this.clearcoatSpecularDirect.add(this.clearcoatSpecularIndirect).mul(clearcoat));\n      outgoingLight.assign(clearcoatLight);\n    }\n    if (this.sheen === true) {\n      const sheenEnergyComp = sheen.r.max(sheen.g).max(sheen.b).mul(0.157).oneMinus();\n      const sheenLight = outgoingLight.mul(sheenEnergyComp).add(this.sheenSpecularDirect, this.sheenSpecularIndirect);\n      outgoingLight.assign(sheenLight);\n    }\n  }\n}\nexport default PhysicalLightingModel;","map":{"version":3,"names":["BRDF_Lambert","BRDF_GGX","DFGApprox","EnvironmentBRDF","F_Schlick","Schlick_to_F0","BRDF_Sheen","LightingModel","diffuseColor","specularColor","roughness","clearcoat","clearcoatRoughness","sheen","sheenRoughness","iridescence","iridescenceIOR","iridescenceThickness","transformedNormalView","transformedClearcoatNormalView","positionViewDirection","tslFn","float","vec3","mat3","cond","mix","smoothstep","XYZ_TO_REC709","Fresnel0ToIor","fresnel0","sqrtF0","sqrt","add","div","sub","IorToFresnel0","transmittedIor","incidentIor","pow2","evalSensitivity","OPD","shift","phase","mul","Math","PI","val","pos","VAR","x","cos","exp","xyz","negate","y","z","rgb","evalIridescence","_ref","outsideIOR","eta2","cosTheta1","thinFilmThickness","baseF0","sinTheta2Sq","cosTheta2Sq","cosTheta2","R0","R12","f0","f90","dotVH","T121","oneMinus","phi12","lessThan","phi21","baseIOR","clamp","R1","R23","phi23","phi","R123","r123","Rs","C0","I","Cm","m","Sm","max","setLayout","name","type","inputs","IBLSheenBRDF","_ref2","normal","viewDir","dotNV","dot","saturate","r2","a","b","DG","clearcoatF0","clearcoatF90","PhysicalLightingModel","constructor","arguments","length","undefined","clearcoatRadiance","clearcoatSpecularDirect","clearcoatSpecularIndirect","sheenSpecularDirect","sheenSpecularIndirect","iridescenceFresnel","iridescenceF0","start","temp","dotNVi","f","computeMultiscattering","singleScatter","multiScatter","specularF90","fab","Fr","FssEss","Ess","Ems","Favg","Fms","addAssign","direct","_ref3","lightDirection","lightColor","reflectedLight","dotNL","irradiance","dotNLcc","ccIrradiance","normalView","directDiffuse","directSpecular","indirectDiffuse","_ref4","indirectSpecular","_ref5","radiance","iblIrradiance","dotNVcc","clearcoatEnv","singleScattering","multiScattering","cosineWeightedIrradiance","totalScattering","diffuse","r","g","ambientOcclusion","_ref6","aoNV","aoExp","exp2","aoNode","pow","mulAssign","finish","context","outgoingLight","Fcc","clearcoatLight","assign","sheenEnergyComp","sheenLight"],"sources":["/Users/vedant/node_modules/three/examples/jsm/nodes/functions/PhysicalLightingModel.js"],"sourcesContent":["import BRDF_Lambert from './BSDF/BRDF_Lambert.js';\nimport BRDF_GGX from './BSDF/BRDF_GGX.js';\nimport DFGApprox from './BSDF/DFGApprox.js';\nimport EnvironmentBRDF from './BSDF/EnvironmentBRDF.js';\nimport F_Schlick from './BSDF/F_Schlick.js';\nimport Schlick_to_F0 from './BSDF/Schlick_to_F0.js';\nimport BRDF_Sheen from './BSDF/BRDF_Sheen.js';\nimport LightingModel from '../core/LightingModel.js';\nimport { diffuseColor, specularColor, roughness, clearcoat, clearcoatRoughness, sheen, sheenRoughness, iridescence, iridescenceIOR, iridescenceThickness } from '../core/PropertyNode.js';\nimport { transformedNormalView, transformedClearcoatNormalView } from '../accessors/NormalNode.js';\nimport { positionViewDirection } from '../accessors/PositionNode.js';\nimport { tslFn, float, vec3, mat3 } from '../shadernode/ShaderNode.js';\nimport { cond } from '../math/CondNode.js';\nimport { mix, smoothstep } from '../math/MathNode.js';\n\n//\n// Iridescence\n//\n\n// XYZ to linear-sRGB color space\nconst XYZ_TO_REC709 = mat3(\n\t3.2404542, - 0.9692660, 0.0556434,\n\t- 1.5371385, 1.8760108, - 0.2040259,\n\t- 0.4985314, 0.0415560, 1.0572252\n);\n\n// Assume air interface for top\n// Note: We don't handle the case fresnel0 == 1\nconst Fresnel0ToIor = ( fresnel0 ) => {\n\n\tconst sqrtF0 = fresnel0.sqrt();\n\treturn vec3( 1.0 ).add( sqrtF0 ).div( vec3( 1.0 ).sub( sqrtF0 ) );\n\n};\n\n// ior is a value between 1.0 and 3.0. 1.0 is air interface\nconst IorToFresnel0 = ( transmittedIor, incidentIor ) => {\n\n\treturn transmittedIor.sub( incidentIor ).div( transmittedIor.add( incidentIor ) ).pow2();\n\n};\n\n// Fresnel equations for dielectric/dielectric interfaces.\n// Ref: https://belcour.github.io/blog/research/2017/05/01/brdf-thin-film.html\n// Evaluation XYZ sensitivity curves in Fourier space\nconst evalSensitivity = ( OPD, shift ) => {\n\n\tconst phase = OPD.mul( 2.0 * Math.PI * 1.0e-9 );\n\tconst val = vec3( 5.4856e-13, 4.4201e-13, 5.2481e-13 );\n\tconst pos = vec3( 1.6810e+06, 1.7953e+06, 2.2084e+06 );\n\tconst VAR = vec3( 4.3278e+09, 9.3046e+09, 6.6121e+09 );\n\n\tconst x = float( 9.7470e-14 * Math.sqrt( 2.0 * Math.PI * 4.5282e+09 ) ).mul( phase.mul( 2.2399e+06 ).add( shift.x ).cos() ).mul( phase.pow2().mul( - 4.5282e+09 ).exp() );\n\n\tlet xyz = val.mul( VAR.mul( 2.0 * Math.PI ).sqrt() ).mul( pos.mul( phase ).add( shift ).cos() ).mul( phase.pow2().negate().mul( VAR ).exp() );\n\txyz = vec3( xyz.x.add( x ), xyz.y, xyz.z ).div( 1.0685e-7 );\n\n\tconst rgb = XYZ_TO_REC709.mul( xyz );\n\n\treturn rgb;\n\n};\n\nconst evalIridescence = tslFn( ( { outsideIOR, eta2, cosTheta1, thinFilmThickness, baseF0 } ) => {\n\n\t// Force iridescenceIOR -> outsideIOR when thinFilmThickness -> 0.0\n\tconst iridescenceIOR = mix( outsideIOR, eta2, smoothstep( 0.0, 0.03, thinFilmThickness ) );\n\t// Evaluate the cosTheta on the base layer (Snell law)\n\tconst sinTheta2Sq = outsideIOR.div( iridescenceIOR ).pow2().mul( float( 1 ).sub( cosTheta1.pow2() ) );\n\n\t// Handle TIR:\n\tconst cosTheta2Sq = float( 1 ).sub( sinTheta2Sq );\n\t/*if ( cosTheta2Sq < 0.0 ) {\n\n\t\t\treturn vec3( 1.0 );\n\n\t}*/\n\n\tconst cosTheta2 = cosTheta2Sq.sqrt();\n\n\t// First interface\n\tconst R0 = IorToFresnel0( iridescenceIOR, outsideIOR );\n\tconst R12 = F_Schlick( { f0: R0, f90: 1.0, dotVH: cosTheta1 } );\n\t//const R21 = R12;\n\tconst T121 = R12.oneMinus();\n\tconst phi12 = iridescenceIOR.lessThan( outsideIOR ).cond( Math.PI, 0.0 );\n\tconst phi21 = float( Math.PI ).sub( phi12 );\n\n\t// Second interface\n\tconst baseIOR = Fresnel0ToIor( baseF0.clamp( 0.0, 0.9999 ) ); // guard against 1.0\n\tconst R1 = IorToFresnel0( baseIOR, iridescenceIOR.vec3() );\n\tconst R23 = F_Schlick( { f0: R1, f90: 1.0, dotVH: cosTheta2 } );\n\tconst phi23 = vec3(\n\t\tbaseIOR.x.lessThan( iridescenceIOR ).cond( Math.PI, 0.0 ),\n\t\tbaseIOR.y.lessThan( iridescenceIOR ).cond( Math.PI, 0.0 ),\n\t\tbaseIOR.z.lessThan( iridescenceIOR ).cond( Math.PI, 0.0 )\n\t);\n\n\t// Phase shift\n\tconst OPD = iridescenceIOR.mul( thinFilmThickness, cosTheta2, 2.0 );\n\tconst phi = vec3( phi21 ).add( phi23 );\n\n\t// Compound terms\n\tconst R123 = R12.mul( R23 ).clamp( 1e-5, 0.9999 );\n\tconst r123 = R123.sqrt();\n\tconst Rs = T121.pow2().mul( R23 ).div( vec3( 1.0 ).sub( R123 ) );\n\n\t// Reflectance term for m = 0 (DC term amplitude)\n\tconst C0 = R12.add( Rs );\n\tlet I = C0;\n\n\t// Reflectance term for m > 0 (pairs of diracs)\n\tlet Cm = Rs.sub( T121 );\n\tfor ( let m = 1; m <= 2; ++ m ) {\n\n\t\tCm = Cm.mul( r123 );\n\t\tconst Sm = evalSensitivity( float( m ).mul( OPD ), float( m ).mul( phi ) ).mul( 2.0 );\n\t\tI = I.add( Cm.mul( Sm ) );\n\n\t}\n\n\t// Since out of gamut colors might be produced, negative color values are clamped to 0.\n\treturn I.max( vec3( 0.0 ) );\n\n} ).setLayout( {\n\tname: 'evalIridescence',\n\ttype: 'vec3',\n\tinputs: [\n\t\t{ name: 'outsideIOR', type: 'float' },\n\t\t{ name: 'eta2', type: 'float' },\n\t\t{ name: 'cosTheta1', type: 'float' },\n\t\t{ name: 'thinFilmThickness', type: 'float' },\n\t\t{ name: 'baseF0', type: 'vec3' }\n\t]\n} );\n\n//\n//\tSheen\n//\n\n// This is a curve-fit approxmation to the \"Charlie sheen\" BRDF integrated over the hemisphere from\n// Estevez and Kulla 2017, \"Production Friendly Microfacet Sheen BRDF\". The analysis can be found\n// in the Sheen section of https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\nconst IBLSheenBRDF = tslFn( ( { normal, viewDir, roughness } ) => {\n\n\tconst dotNV = normal.dot( viewDir ).saturate();\n\n\tconst r2 = roughness.pow2();\n\n\tconst a = cond(\n\t\troughness.lessThan( 0.25 ),\n\t\tfloat( - 339.2 ).mul( r2 ).add( float( 161.4 ).mul( roughness ) ).sub( 25.9 ),\n\t\tfloat( - 8.48 ).mul( r2 ).add( float( 14.3 ).mul( roughness ) ).sub( 9.95 )\n\t);\n\n\tconst b = cond(\n\t\troughness.lessThan( 0.25 ),\n\t\tfloat( 44.0 ).mul( r2 ).sub( float( 23.7 ).mul( roughness ) ).add( 3.26 ),\n\t\tfloat( 1.97 ).mul( r2 ).sub( float( 3.27 ).mul( roughness ) ).add( 0.72 )\n\t);\n\n\tconst DG = cond( roughness.lessThan( 0.25 ), 0.0, float( 0.1 ).mul( roughness ).sub( 0.025 ) ).add( a.mul( dotNV ).add( b ).exp() );\n\n\treturn DG.mul( 1.0 / Math.PI ).saturate();\n\n} );\n\nconst clearcoatF0 = vec3( 0.04 );\nconst clearcoatF90 = vec3( 1 );\n\n//\n\nclass PhysicalLightingModel extends LightingModel {\n\n\tconstructor( clearcoat = false, sheen = false, iridescence = false ) {\n\n\t\tsuper();\n\n\t\tthis.clearcoat = clearcoat;\n\t\tthis.sheen = sheen;\n\t\tthis.iridescence = iridescence;\n\n\t\tthis.clearcoatRadiance = null;\n\t\tthis.clearcoatSpecularDirect = null;\n\t\tthis.clearcoatSpecularIndirect = null;\n\t\tthis.sheenSpecularDirect = null;\n\t\tthis.sheenSpecularIndirect = null;\n\t\tthis.iridescenceFresnel = null;\n\t\tthis.iridescenceF0 = null;\n\n\t}\n\n\tstart( /*context*/ ) {\n\n\t\tif ( this.clearcoat === true ) {\n\n\t\t\tthis.clearcoatRadiance = vec3().temp( 'clearcoatRadiance' );\n\t\t\tthis.clearcoatSpecularDirect = vec3().temp( 'clearcoatSpecularDirect' );\n\t\t\tthis.clearcoatSpecularIndirect = vec3().temp( 'clearcoatSpecularIndirect' );\n\n\t\t}\n\n\t\tif ( this.sheen === true ) {\n\n\t\t\tthis.sheenSpecularDirect = vec3().temp( 'sheenSpecularDirect' );\n\t\t\tthis.sheenSpecularIndirect = vec3().temp( 'sheenSpecularIndirect' );\n\n\t\t}\n\n\t\tif ( this.iridescence === true ) {\n\n\t\t\tconst dotNVi = transformedNormalView.dot( positionViewDirection ).clamp();\n\n\t\t\tthis.iridescenceFresnel = evalIridescence( {\n\t\t\t\toutsideIOR: float( 1.0 ),\n\t\t\t\teta2: iridescenceIOR,\n\t\t\t\tcosTheta1: dotNVi,\n\t\t\t\tthinFilmThickness: iridescenceThickness,\n\t\t\t\tbaseF0: specularColor\n\t\t\t} );\n\n\t\t\tthis.iridescenceF0 = Schlick_to_F0( { f: this.iridescenceFresnel, f90: 1.0, dotVH: dotNVi } );\n\n\t\t}\n\n\t}\n\n\t// Fdez-AgÃ¼era's \"Multiple-Scattering Microfacet Model for Real-Time Image Based Lighting\"\n\t// Approximates multiscattering in order to preserve energy.\n\t// http://www.jcgt.org/published/0008/01/03/\n\n\tcomputeMultiscattering( singleScatter, multiScatter, specularF90 = float( 1 ) ) {\n\n\t\tconst dotNV = transformedNormalView.dot( positionViewDirection ).clamp(); // @ TODO: Move to core dotNV\n\n\t\tconst fab = DFGApprox( { roughness, dotNV } );\n\n\t\tconst Fr = this.iridescenceF0 ? iridescence.mix( specularColor, this.iridescenceF0 ) : specularColor;\n\n\t\tconst FssEss = Fr.mul( fab.x ).add( specularF90.mul( fab.y ) );\n\n\t\tconst Ess = fab.x.add( fab.y );\n\t\tconst Ems = Ess.oneMinus();\n\n\t\tconst Favg = specularColor.add( specularColor.oneMinus().mul( 0.047619 ) ); // 1/21\n\t\tconst Fms = FssEss.mul( Favg ).div( Ems.mul( Favg ).oneMinus() );\n\n\t\tsingleScatter.addAssign( FssEss );\n\t\tmultiScatter.addAssign( Fms.mul( Ems ) );\n\n\t}\n\n\tdirect( { lightDirection, lightColor, reflectedLight } ) {\n\n\t\tconst dotNL = transformedNormalView.dot( lightDirection ).clamp();\n\t\tconst irradiance = dotNL.mul( lightColor );\n\n\t\tif ( this.sheen === true ) {\n\n\t\t\tthis.sheenSpecularDirect.addAssign( irradiance.mul( BRDF_Sheen( { lightDirection } ) ) );\n\n\t\t}\n\n\t\tif ( this.clearcoat === true ) {\n\n\t\t\tconst dotNLcc = transformedClearcoatNormalView.dot( lightDirection ).clamp();\n\t\t\tconst ccIrradiance = dotNLcc.mul( lightColor );\n\n\t\t\tthis.clearcoatSpecularDirect.addAssign( ccIrradiance.mul( BRDF_GGX( { lightDirection, f0: clearcoatF0, f90: clearcoatF90, roughness: clearcoatRoughness, normalView: transformedClearcoatNormalView } ) ) );\n\n\t\t}\n\n\t\treflectedLight.directDiffuse.addAssign( irradiance.mul( BRDF_Lambert( { diffuseColor: diffuseColor.rgb } ) ) );\n\n\t\treflectedLight.directSpecular.addAssign( irradiance.mul( BRDF_GGX( { lightDirection, f0: specularColor, f90: 1, roughness, iridescence: this.iridescence, iridescenceFresnel: this.iridescenceFresnel } ) ) );\n\n\t}\n\n\tindirectDiffuse( { irradiance, reflectedLight } ) {\n\n\t\treflectedLight.indirectDiffuse.addAssign( irradiance.mul( BRDF_Lambert( { diffuseColor } ) ) );\n\n\t}\n\n\tindirectSpecular( { radiance, iblIrradiance, reflectedLight } ) {\n\n\t\tif ( this.sheen === true ) {\n\n\t\t\tthis.sheenSpecularIndirect.addAssign( iblIrradiance.mul(\n\t\t\t\tsheen,\n\t\t\t\tIBLSheenBRDF( {\n\t\t\t\t\tnormal: transformedNormalView,\n\t\t\t\t\tviewDir: positionViewDirection,\n\t\t\t\t\troughness: sheenRoughness\n\t\t\t\t} )\n\t\t\t) );\n\n\t\t}\n\n\t\tif ( this.clearcoat === true ) {\n\n\t\t\tconst dotNVcc = transformedClearcoatNormalView.dot( positionViewDirection ).clamp();\n\n\t\t\tconst clearcoatEnv = EnvironmentBRDF( {\n\t\t\t\tdotNV: dotNVcc,\n\t\t\t\tspecularColor: clearcoatF0,\n\t\t\t\tspecularF90: clearcoatF90,\n\t\t\t\troughness: clearcoatRoughness\n\t\t\t} );\n\n\t\t\tthis.clearcoatSpecularIndirect.addAssign( this.clearcoatRadiance.mul( clearcoatEnv ) );\n\n\t\t}\n\n\t\t// Both indirect specular and indirect diffuse light accumulate here\n\n\t\tconst singleScattering = vec3().temp( 'singleScattering' );\n\t\tconst multiScattering = vec3().temp( 'multiScattering' );\n\t\tconst cosineWeightedIrradiance = iblIrradiance.mul( 1 / Math.PI );\n\n\t\tthis.computeMultiscattering( singleScattering, multiScattering );\n\n\t\tconst totalScattering = singleScattering.add( multiScattering );\n\n\t\tconst diffuse = diffuseColor.mul( totalScattering.r.max( totalScattering.g ).max( totalScattering.b ).oneMinus() );\n\n\t\treflectedLight.indirectSpecular.addAssign( radiance.mul( singleScattering ) );\n\t\treflectedLight.indirectSpecular.addAssign( multiScattering.mul( cosineWeightedIrradiance ) );\n\n\t\treflectedLight.indirectDiffuse.addAssign( diffuse.mul( cosineWeightedIrradiance ) );\n\n\t}\n\n\tambientOcclusion( { ambientOcclusion, reflectedLight } ) {\n\n\t\tconst dotNV = transformedNormalView.dot( positionViewDirection ).clamp(); // @ TODO: Move to core dotNV\n\n\t\tconst aoNV = dotNV.add( ambientOcclusion );\n\t\tconst aoExp = roughness.mul( - 16.0 ).oneMinus().negate().exp2();\n\n\t\tconst aoNode = ambientOcclusion.sub( aoNV.pow( aoExp ).oneMinus() ).clamp();\n\n\t\tif ( this.clearcoat === true ) {\n\n\t\t\tthis.clearcoatSpecularIndirect.mulAssign( ambientOcclusion );\n\n\t\t}\n\n\t\tif ( this.sheen === true ) {\n\n\t\t\tthis.sheenSpecularIndirect.mulAssign( ambientOcclusion );\n\n\t\t}\n\n\t\treflectedLight.indirectDiffuse.mulAssign( ambientOcclusion );\n\t\treflectedLight.indirectSpecular.mulAssign( aoNode );\n\n\t}\n\n\tfinish( context ) {\n\n\t\tconst { outgoingLight } = context;\n\n\t\tif ( this.clearcoat === true ) {\n\n\t\t\tconst dotNVcc = transformedClearcoatNormalView.dot( positionViewDirection ).clamp();\n\n\t\t\tconst Fcc = F_Schlick( {\n\t\t\t\tdotVH: dotNVcc,\n\t\t\t\tf0: clearcoatF0,\n\t\t\t\tf90: clearcoatF90\n\t\t\t} );\n\n\t\t\tconst clearcoatLight = outgoingLight.mul( clearcoat.mul( Fcc ).oneMinus() ).add( this.clearcoatSpecularDirect.add( this.clearcoatSpecularIndirect ).mul( clearcoat ) );\n\n\t\t\toutgoingLight.assign( clearcoatLight );\n\n\t\t}\n\n\t\tif ( this.sheen === true ) {\n\n\t\t\tconst sheenEnergyComp = sheen.r.max( sheen.g ).max( sheen.b ).mul( 0.157 ).oneMinus();\n\t\t\tconst sheenLight = outgoingLight.mul( sheenEnergyComp ).add( this.sheenSpecularDirect, this.sheenSpecularIndirect );\n\n\t\t\toutgoingLight.assign( sheenLight );\n\n\t\t}\n\n\t}\n\n}\n\nexport default PhysicalLightingModel;\n"],"mappings":"AAAA,OAAOA,YAAY,MAAM,wBAAwB;AACjD,OAAOC,QAAQ,MAAM,oBAAoB;AACzC,OAAOC,SAAS,MAAM,qBAAqB;AAC3C,OAAOC,eAAe,MAAM,2BAA2B;AACvD,OAAOC,SAAS,MAAM,qBAAqB;AAC3C,OAAOC,aAAa,MAAM,yBAAyB;AACnD,OAAOC,UAAU,MAAM,sBAAsB;AAC7C,OAAOC,aAAa,MAAM,0BAA0B;AACpD,SAASC,YAAY,EAAEC,aAAa,EAAEC,SAAS,EAAEC,SAAS,EAAEC,kBAAkB,EAAEC,KAAK,EAAEC,cAAc,EAAEC,WAAW,EAAEC,cAAc,EAAEC,oBAAoB,QAAQ,yBAAyB;AACzL,SAASC,qBAAqB,EAAEC,8BAA8B,QAAQ,4BAA4B;AAClG,SAASC,qBAAqB,QAAQ,8BAA8B;AACpE,SAASC,KAAK,EAAEC,KAAK,EAAEC,IAAI,EAAEC,IAAI,QAAQ,6BAA6B;AACtE,SAASC,IAAI,QAAQ,qBAAqB;AAC1C,SAASC,GAAG,EAAEC,UAAU,QAAQ,qBAAqB;;AAErD;AACA;AACA;;AAEA;AACA,MAAMC,aAAa,GAAGJ,IAAI,CACzB,SAAS,EAAE,CAAE,SAAS,EAAE,SAAS,EACjC,CAAE,SAAS,EAAE,SAAS,EAAE,CAAE,SAAS,EACnC,CAAE,SAAS,EAAE,SAAS,EAAE,SACzB,CAAC;;AAED;AACA;AACA,MAAMK,aAAa,GAAKC,QAAQ,IAAM;EAErC,MAAMC,MAAM,GAAGD,QAAQ,CAACE,IAAI,CAAC,CAAC;EAC9B,OAAOT,IAAI,CAAE,GAAI,CAAC,CAACU,GAAG,CAAEF,MAAO,CAAC,CAACG,GAAG,CAAEX,IAAI,CAAE,GAAI,CAAC,CAACY,GAAG,CAAEJ,MAAO,CAAE,CAAC;AAElE,CAAC;;AAED;AACA,MAAMK,aAAa,GAAGA,CAAEC,cAAc,EAAEC,WAAW,KAAM;EAExD,OAAOD,cAAc,CAACF,GAAG,CAAEG,WAAY,CAAC,CAACJ,GAAG,CAAEG,cAAc,CAACJ,GAAG,CAAEK,WAAY,CAAE,CAAC,CAACC,IAAI,CAAC,CAAC;AAEzF,CAAC;;AAED;AACA;AACA;AACA,MAAMC,eAAe,GAAGA,CAAEC,GAAG,EAAEC,KAAK,KAAM;EAEzC,MAAMC,KAAK,GAAGF,GAAG,CAACG,GAAG,CAAE,GAAG,GAAGC,IAAI,CAACC,EAAE,GAAG,MAAO,CAAC;EAC/C,MAAMC,GAAG,GAAGxB,IAAI,CAAE,UAAU,EAAE,UAAU,EAAE,UAAW,CAAC;EACtD,MAAMyB,GAAG,GAAGzB,IAAI,CAAE,UAAU,EAAE,UAAU,EAAE,UAAW,CAAC;EACtD,MAAM0B,GAAG,GAAG1B,IAAI,CAAE,UAAU,EAAE,UAAU,EAAE,UAAW,CAAC;EAEtD,MAAM2B,CAAC,GAAG5B,KAAK,CAAE,UAAU,GAAGuB,IAAI,CAACb,IAAI,CAAE,GAAG,GAAGa,IAAI,CAACC,EAAE,GAAG,UAAW,CAAE,CAAC,CAACF,GAAG,CAAED,KAAK,CAACC,GAAG,CAAE,UAAW,CAAC,CAACX,GAAG,CAAES,KAAK,CAACQ,CAAE,CAAC,CAACC,GAAG,CAAC,CAAE,CAAC,CAACP,GAAG,CAAED,KAAK,CAACJ,IAAI,CAAC,CAAC,CAACK,GAAG,CAAE,CAAE,UAAW,CAAC,CAACQ,GAAG,CAAC,CAAE,CAAC;EAEzK,IAAIC,GAAG,GAAGN,GAAG,CAACH,GAAG,CAAEK,GAAG,CAACL,GAAG,CAAE,GAAG,GAAGC,IAAI,CAACC,EAAG,CAAC,CAACd,IAAI,CAAC,CAAE,CAAC,CAACY,GAAG,CAAEI,GAAG,CAACJ,GAAG,CAAED,KAAM,CAAC,CAACV,GAAG,CAAES,KAAM,CAAC,CAACS,GAAG,CAAC,CAAE,CAAC,CAACP,GAAG,CAAED,KAAK,CAACJ,IAAI,CAAC,CAAC,CAACe,MAAM,CAAC,CAAC,CAACV,GAAG,CAAEK,GAAI,CAAC,CAACG,GAAG,CAAC,CAAE,CAAC;EAC7IC,GAAG,GAAG9B,IAAI,CAAE8B,GAAG,CAACH,CAAC,CAACjB,GAAG,CAAEiB,CAAE,CAAC,EAAEG,GAAG,CAACE,CAAC,EAAEF,GAAG,CAACG,CAAE,CAAC,CAACtB,GAAG,CAAE,SAAU,CAAC;EAE3D,MAAMuB,GAAG,GAAG7B,aAAa,CAACgB,GAAG,CAAES,GAAI,CAAC;EAEpC,OAAOI,GAAG;AAEX,CAAC;AAED,MAAMC,eAAe,GAAGrC,KAAK,CAAEsC,IAAA,IAAkE;EAAA,IAAhE;IAAEC,UAAU;IAAEC,IAAI;IAAEC,SAAS;IAAEC,iBAAiB;IAAEC;EAAO,CAAC,GAAAL,IAAA;EAE1F;EACA,MAAM3C,cAAc,GAAGU,GAAG,CAAEkC,UAAU,EAAEC,IAAI,EAAElC,UAAU,CAAE,GAAG,EAAE,IAAI,EAAEoC,iBAAkB,CAAE,CAAC;EAC1F;EACA,MAAME,WAAW,GAAGL,UAAU,CAAC1B,GAAG,CAAElB,cAAe,CAAC,CAACuB,IAAI,CAAC,CAAC,CAACK,GAAG,CAAEtB,KAAK,CAAE,CAAE,CAAC,CAACa,GAAG,CAAE2B,SAAS,CAACvB,IAAI,CAAC,CAAE,CAAE,CAAC;;EAErG;EACA,MAAM2B,WAAW,GAAG5C,KAAK,CAAE,CAAE,CAAC,CAACa,GAAG,CAAE8B,WAAY,CAAC;EACjD;AACD;AACA;;EAIC,MAAME,SAAS,GAAGD,WAAW,CAAClC,IAAI,CAAC,CAAC;;EAEpC;EACA,MAAMoC,EAAE,GAAGhC,aAAa,CAAEpB,cAAc,EAAE4C,UAAW,CAAC;EACtD,MAAMS,GAAG,GAAGjE,SAAS,CAAE;IAAEkE,EAAE,EAAEF,EAAE;IAAEG,GAAG,EAAE,GAAG;IAAEC,KAAK,EAAEV;EAAU,CAAE,CAAC;EAC/D;EACA,MAAMW,IAAI,GAAGJ,GAAG,CAACK,QAAQ,CAAC,CAAC;EAC3B,MAAMC,KAAK,GAAG3D,cAAc,CAAC4D,QAAQ,CAAEhB,UAAW,CAAC,CAACnC,IAAI,CAAEoB,IAAI,CAACC,EAAE,EAAE,GAAI,CAAC;EACxE,MAAM+B,KAAK,GAAGvD,KAAK,CAAEuB,IAAI,CAACC,EAAG,CAAC,CAACX,GAAG,CAAEwC,KAAM,CAAC;;EAE3C;EACA,MAAMG,OAAO,GAAGjD,aAAa,CAAEmC,MAAM,CAACe,KAAK,CAAE,GAAG,EAAE,MAAO,CAAE,CAAC,CAAC,CAAC;EAC9D,MAAMC,EAAE,GAAG5C,aAAa,CAAE0C,OAAO,EAAE9D,cAAc,CAACO,IAAI,CAAC,CAAE,CAAC;EAC1D,MAAM0D,GAAG,GAAG7E,SAAS,CAAE;IAAEkE,EAAE,EAAEU,EAAE;IAAET,GAAG,EAAE,GAAG;IAAEC,KAAK,EAAEL;EAAU,CAAE,CAAC;EAC/D,MAAMe,KAAK,GAAG3D,IAAI,CACjBuD,OAAO,CAAC5B,CAAC,CAAC0B,QAAQ,CAAE5D,cAAe,CAAC,CAACS,IAAI,CAAEoB,IAAI,CAACC,EAAE,EAAE,GAAI,CAAC,EACzDgC,OAAO,CAACvB,CAAC,CAACqB,QAAQ,CAAE5D,cAAe,CAAC,CAACS,IAAI,CAAEoB,IAAI,CAACC,EAAE,EAAE,GAAI,CAAC,EACzDgC,OAAO,CAACtB,CAAC,CAACoB,QAAQ,CAAE5D,cAAe,CAAC,CAACS,IAAI,CAAEoB,IAAI,CAACC,EAAE,EAAE,GAAI,CACzD,CAAC;;EAED;EACA,MAAML,GAAG,GAAGzB,cAAc,CAAC4B,GAAG,CAAEmB,iBAAiB,EAAEI,SAAS,EAAE,GAAI,CAAC;EACnE,MAAMgB,GAAG,GAAG5D,IAAI,CAAEsD,KAAM,CAAC,CAAC5C,GAAG,CAAEiD,KAAM,CAAC;;EAEtC;EACA,MAAME,IAAI,GAAGf,GAAG,CAACzB,GAAG,CAAEqC,GAAI,CAAC,CAACF,KAAK,CAAE,IAAI,EAAE,MAAO,CAAC;EACjD,MAAMM,IAAI,GAAGD,IAAI,CAACpD,IAAI,CAAC,CAAC;EACxB,MAAMsD,EAAE,GAAGb,IAAI,CAAClC,IAAI,CAAC,CAAC,CAACK,GAAG,CAAEqC,GAAI,CAAC,CAAC/C,GAAG,CAAEX,IAAI,CAAE,GAAI,CAAC,CAACY,GAAG,CAAEiD,IAAK,CAAE,CAAC;;EAEhE;EACA,MAAMG,EAAE,GAAGlB,GAAG,CAACpC,GAAG,CAAEqD,EAAG,CAAC;EACxB,IAAIE,CAAC,GAAGD,EAAE;;EAEV;EACA,IAAIE,EAAE,GAAGH,EAAE,CAACnD,GAAG,CAAEsC,IAAK,CAAC;EACvB,KAAM,IAAIiB,CAAC,GAAG,CAAC,EAAEA,CAAC,IAAI,CAAC,EAAE,EAAGA,CAAC,EAAG;IAE/BD,EAAE,GAAGA,EAAE,CAAC7C,GAAG,CAAEyC,IAAK,CAAC;IACnB,MAAMM,EAAE,GAAGnD,eAAe,CAAElB,KAAK,CAAEoE,CAAE,CAAC,CAAC9C,GAAG,CAAEH,GAAI,CAAC,EAAEnB,KAAK,CAAEoE,CAAE,CAAC,CAAC9C,GAAG,CAAEuC,GAAI,CAAE,CAAC,CAACvC,GAAG,CAAE,GAAI,CAAC;IACrF4C,CAAC,GAAGA,CAAC,CAACvD,GAAG,CAAEwD,EAAE,CAAC7C,GAAG,CAAE+C,EAAG,CAAE,CAAC;EAE1B;;EAEA;EACA,OAAOH,CAAC,CAACI,GAAG,CAAErE,IAAI,CAAE,GAAI,CAAE,CAAC;AAE5B,CAAE,CAAC,CAACsE,SAAS,CAAE;EACdC,IAAI,EAAE,iBAAiB;EACvBC,IAAI,EAAE,MAAM;EACZC,MAAM,EAAE,CACP;IAAEF,IAAI,EAAE,YAAY;IAAEC,IAAI,EAAE;EAAQ,CAAC,EACrC;IAAED,IAAI,EAAE,MAAM;IAAEC,IAAI,EAAE;EAAQ,CAAC,EAC/B;IAAED,IAAI,EAAE,WAAW;IAAEC,IAAI,EAAE;EAAQ,CAAC,EACpC;IAAED,IAAI,EAAE,mBAAmB;IAAEC,IAAI,EAAE;EAAQ,CAAC,EAC5C;IAAED,IAAI,EAAE,QAAQ;IAAEC,IAAI,EAAE;EAAO,CAAC;AAElC,CAAE,CAAC;;AAEH;AACA;AACA;;AAEA;AACA;AACA;AACA,MAAME,YAAY,GAAG5E,KAAK,CAAE6E,KAAA,IAAsC;EAAA,IAApC;IAAEC,MAAM;IAAEC,OAAO;IAAE1F;EAAU,CAAC,GAAAwF,KAAA;EAE3D,MAAMG,KAAK,GAAGF,MAAM,CAACG,GAAG,CAAEF,OAAQ,CAAC,CAACG,QAAQ,CAAC,CAAC;EAE9C,MAAMC,EAAE,GAAG9F,SAAS,CAAC6B,IAAI,CAAC,CAAC;EAE3B,MAAMkE,CAAC,GAAGhF,IAAI,CACbf,SAAS,CAACkE,QAAQ,CAAE,IAAK,CAAC,EAC1BtD,KAAK,CAAE,CAAE,KAAM,CAAC,CAACsB,GAAG,CAAE4D,EAAG,CAAC,CAACvE,GAAG,CAAEX,KAAK,CAAE,KAAM,CAAC,CAACsB,GAAG,CAAElC,SAAU,CAAE,CAAC,CAACyB,GAAG,CAAE,IAAK,CAAC,EAC7Eb,KAAK,CAAE,CAAE,IAAK,CAAC,CAACsB,GAAG,CAAE4D,EAAG,CAAC,CAACvE,GAAG,CAAEX,KAAK,CAAE,IAAK,CAAC,CAACsB,GAAG,CAAElC,SAAU,CAAE,CAAC,CAACyB,GAAG,CAAE,IAAK,CAC3E,CAAC;EAED,MAAMuE,CAAC,GAAGjF,IAAI,CACbf,SAAS,CAACkE,QAAQ,CAAE,IAAK,CAAC,EAC1BtD,KAAK,CAAE,IAAK,CAAC,CAACsB,GAAG,CAAE4D,EAAG,CAAC,CAACrE,GAAG,CAAEb,KAAK,CAAE,IAAK,CAAC,CAACsB,GAAG,CAAElC,SAAU,CAAE,CAAC,CAACuB,GAAG,CAAE,IAAK,CAAC,EACzEX,KAAK,CAAE,IAAK,CAAC,CAACsB,GAAG,CAAE4D,EAAG,CAAC,CAACrE,GAAG,CAAEb,KAAK,CAAE,IAAK,CAAC,CAACsB,GAAG,CAAElC,SAAU,CAAE,CAAC,CAACuB,GAAG,CAAE,IAAK,CACzE,CAAC;EAED,MAAM0E,EAAE,GAAGlF,IAAI,CAAEf,SAAS,CAACkE,QAAQ,CAAE,IAAK,CAAC,EAAE,GAAG,EAAEtD,KAAK,CAAE,GAAI,CAAC,CAACsB,GAAG,CAAElC,SAAU,CAAC,CAACyB,GAAG,CAAE,KAAM,CAAE,CAAC,CAACF,GAAG,CAAEwE,CAAC,CAAC7D,GAAG,CAAEyD,KAAM,CAAC,CAACpE,GAAG,CAAEyE,CAAE,CAAC,CAACtD,GAAG,CAAC,CAAE,CAAC;EAEnI,OAAOuD,EAAE,CAAC/D,GAAG,CAAE,GAAG,GAAGC,IAAI,CAACC,EAAG,CAAC,CAACyD,QAAQ,CAAC,CAAC;AAE1C,CAAE,CAAC;AAEH,MAAMK,WAAW,GAAGrF,IAAI,CAAE,IAAK,CAAC;AAChC,MAAMsF,YAAY,GAAGtF,IAAI,CAAE,CAAE,CAAC;;AAE9B;;AAEA,MAAMuF,qBAAqB,SAASvG,aAAa,CAAC;EAEjDwG,WAAWA,CAAA,EAA0D;IAAA,IAAxDpG,SAAS,GAAAqG,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,KAAK;IAAA,IAAEnG,KAAK,GAAAmG,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,KAAK;IAAA,IAAEjG,WAAW,GAAAiG,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG,KAAK;IAEjE,KAAK,CAAC,CAAC;IAEP,IAAI,CAACrG,SAAS,GAAGA,SAAS;IAC1B,IAAI,CAACE,KAAK,GAAGA,KAAK;IAClB,IAAI,CAACE,WAAW,GAAGA,WAAW;IAE9B,IAAI,CAACoG,iBAAiB,GAAG,IAAI;IAC7B,IAAI,CAACC,uBAAuB,GAAG,IAAI;IACnC,IAAI,CAACC,yBAAyB,GAAG,IAAI;IACrC,IAAI,CAACC,mBAAmB,GAAG,IAAI;IAC/B,IAAI,CAACC,qBAAqB,GAAG,IAAI;IACjC,IAAI,CAACC,kBAAkB,GAAG,IAAI;IAC9B,IAAI,CAACC,aAAa,GAAG,IAAI;EAE1B;EAEAC,KAAKA,CAAA,CAAE;EAAA,EAAc;IAEpB,IAAK,IAAI,CAAC/G,SAAS,KAAK,IAAI,EAAG;MAE9B,IAAI,CAACwG,iBAAiB,GAAG5F,IAAI,CAAC,CAAC,CAACoG,IAAI,CAAE,mBAAoB,CAAC;MAC3D,IAAI,CAACP,uBAAuB,GAAG7F,IAAI,CAAC,CAAC,CAACoG,IAAI,CAAE,yBAA0B,CAAC;MACvE,IAAI,CAACN,yBAAyB,GAAG9F,IAAI,CAAC,CAAC,CAACoG,IAAI,CAAE,2BAA4B,CAAC;IAE5E;IAEA,IAAK,IAAI,CAAC9G,KAAK,KAAK,IAAI,EAAG;MAE1B,IAAI,CAACyG,mBAAmB,GAAG/F,IAAI,CAAC,CAAC,CAACoG,IAAI,CAAE,qBAAsB,CAAC;MAC/D,IAAI,CAACJ,qBAAqB,GAAGhG,IAAI,CAAC,CAAC,CAACoG,IAAI,CAAE,uBAAwB,CAAC;IAEpE;IAEA,IAAK,IAAI,CAAC5G,WAAW,KAAK,IAAI,EAAG;MAEhC,MAAM6G,MAAM,GAAG1G,qBAAqB,CAACoF,GAAG,CAAElF,qBAAsB,CAAC,CAAC2D,KAAK,CAAC,CAAC;MAEzE,IAAI,CAACyC,kBAAkB,GAAG9D,eAAe,CAAE;QAC1CE,UAAU,EAAEtC,KAAK,CAAE,GAAI,CAAC;QACxBuC,IAAI,EAAE7C,cAAc;QACpB8C,SAAS,EAAE8D,MAAM;QACjB7D,iBAAiB,EAAE9C,oBAAoB;QACvC+C,MAAM,EAAEvD;MACT,CAAE,CAAC;MAEH,IAAI,CAACgH,aAAa,GAAGpH,aAAa,CAAE;QAAEwH,CAAC,EAAE,IAAI,CAACL,kBAAkB;QAAEjD,GAAG,EAAE,GAAG;QAAEC,KAAK,EAAEoD;MAAO,CAAE,CAAC;IAE9F;EAED;;EAEA;EACA;EACA;;EAEAE,sBAAsBA,CAAEC,aAAa,EAAEC,YAAY,EAA6B;IAAA,IAA3BC,WAAW,GAAAjB,SAAA,CAAAC,MAAA,QAAAD,SAAA,QAAAE,SAAA,GAAAF,SAAA,MAAG1F,KAAK,CAAE,CAAE,CAAC;IAE5E,MAAM+E,KAAK,GAAGnF,qBAAqB,CAACoF,GAAG,CAAElF,qBAAsB,CAAC,CAAC2D,KAAK,CAAC,CAAC,CAAC,CAAC;;IAE1E,MAAMmD,GAAG,GAAGhI,SAAS,CAAE;MAAEQ,SAAS;MAAE2F;IAAM,CAAE,CAAC;IAE7C,MAAM8B,EAAE,GAAG,IAAI,CAACV,aAAa,GAAG1G,WAAW,CAACW,GAAG,CAAEjB,aAAa,EAAE,IAAI,CAACgH,aAAc,CAAC,GAAGhH,aAAa;IAEpG,MAAM2H,MAAM,GAAGD,EAAE,CAACvF,GAAG,CAAEsF,GAAG,CAAChF,CAAE,CAAC,CAACjB,GAAG,CAAEgG,WAAW,CAACrF,GAAG,CAAEsF,GAAG,CAAC3E,CAAE,CAAE,CAAC;IAE9D,MAAM8E,GAAG,GAAGH,GAAG,CAAChF,CAAC,CAACjB,GAAG,CAAEiG,GAAG,CAAC3E,CAAE,CAAC;IAC9B,MAAM+E,GAAG,GAAGD,GAAG,CAAC3D,QAAQ,CAAC,CAAC;IAE1B,MAAM6D,IAAI,GAAG9H,aAAa,CAACwB,GAAG,CAAExB,aAAa,CAACiE,QAAQ,CAAC,CAAC,CAAC9B,GAAG,CAAE,QAAS,CAAE,CAAC,CAAC,CAAC;IAC5E,MAAM4F,GAAG,GAAGJ,MAAM,CAACxF,GAAG,CAAE2F,IAAK,CAAC,CAACrG,GAAG,CAAEoG,GAAG,CAAC1F,GAAG,CAAE2F,IAAK,CAAC,CAAC7D,QAAQ,CAAC,CAAE,CAAC;IAEhEqD,aAAa,CAACU,SAAS,CAAEL,MAAO,CAAC;IACjCJ,YAAY,CAACS,SAAS,CAAED,GAAG,CAAC5F,GAAG,CAAE0F,GAAI,CAAE,CAAC;EAEzC;EAEAI,MAAMA,CAAAC,KAAA,EAAmD;IAAA,IAAjD;MAAEC,cAAc;MAAEC,UAAU;MAAEC;IAAe,CAAC,GAAAH,KAAA;IAErD,MAAMI,KAAK,GAAG7H,qBAAqB,CAACoF,GAAG,CAAEsC,cAAe,CAAC,CAAC7D,KAAK,CAAC,CAAC;IACjE,MAAMiE,UAAU,GAAGD,KAAK,CAACnG,GAAG,CAAEiG,UAAW,CAAC;IAE1C,IAAK,IAAI,CAAChI,KAAK,KAAK,IAAI,EAAG;MAE1B,IAAI,CAACyG,mBAAmB,CAACmB,SAAS,CAAEO,UAAU,CAACpG,GAAG,CAAEtC,UAAU,CAAE;QAAEsI;MAAe,CAAE,CAAE,CAAE,CAAC;IAEzF;IAEA,IAAK,IAAI,CAACjI,SAAS,KAAK,IAAI,EAAG;MAE9B,MAAMsI,OAAO,GAAG9H,8BAA8B,CAACmF,GAAG,CAAEsC,cAAe,CAAC,CAAC7D,KAAK,CAAC,CAAC;MAC5E,MAAMmE,YAAY,GAAGD,OAAO,CAACrG,GAAG,CAAEiG,UAAW,CAAC;MAE9C,IAAI,CAACzB,uBAAuB,CAACqB,SAAS,CAAES,YAAY,CAACtG,GAAG,CAAE3C,QAAQ,CAAE;QAAE2I,cAAc;QAAEtE,EAAE,EAAEsC,WAAW;QAAErC,GAAG,EAAEsC,YAAY;QAAEnG,SAAS,EAAEE,kBAAkB;QAAEuI,UAAU,EAAEhI;MAA+B,CAAE,CAAE,CAAE,CAAC;IAE5M;IAEA2H,cAAc,CAACM,aAAa,CAACX,SAAS,CAAEO,UAAU,CAACpG,GAAG,CAAE5C,YAAY,CAAE;MAAEQ,YAAY,EAAEA,YAAY,CAACiD;IAAI,CAAE,CAAE,CAAE,CAAC;IAE9GqF,cAAc,CAACO,cAAc,CAACZ,SAAS,CAAEO,UAAU,CAACpG,GAAG,CAAE3C,QAAQ,CAAE;MAAE2I,cAAc;MAAEtE,EAAE,EAAE7D,aAAa;MAAE8D,GAAG,EAAE,CAAC;MAAE7D,SAAS;MAAEK,WAAW,EAAE,IAAI,CAACA,WAAW;MAAEyG,kBAAkB,EAAE,IAAI,CAACA;IAAmB,CAAE,CAAE,CAAE,CAAC;EAE9M;EAEA8B,eAAeA,CAAAC,KAAA,EAAmC;IAAA,IAAjC;MAAEP,UAAU;MAAEF;IAAe,CAAC,GAAAS,KAAA;IAE9CT,cAAc,CAACQ,eAAe,CAACb,SAAS,CAAEO,UAAU,CAACpG,GAAG,CAAE5C,YAAY,CAAE;MAAEQ;IAAa,CAAE,CAAE,CAAE,CAAC;EAE/F;EAEAgJ,gBAAgBA,CAAAC,KAAA,EAAgD;IAAA,IAA9C;MAAEC,QAAQ;MAAEC,aAAa;MAAEb;IAAe,CAAC,GAAAW,KAAA;IAE5D,IAAK,IAAI,CAAC5I,KAAK,KAAK,IAAI,EAAG;MAE1B,IAAI,CAAC0G,qBAAqB,CAACkB,SAAS,CAAEkB,aAAa,CAAC/G,GAAG,CACtD/B,KAAK,EACLoF,YAAY,CAAE;QACbE,MAAM,EAAEjF,qBAAqB;QAC7BkF,OAAO,EAAEhF,qBAAqB;QAC9BV,SAAS,EAAEI;MACZ,CAAE,CACH,CAAE,CAAC;IAEJ;IAEA,IAAK,IAAI,CAACH,SAAS,KAAK,IAAI,EAAG;MAE9B,MAAMiJ,OAAO,GAAGzI,8BAA8B,CAACmF,GAAG,CAAElF,qBAAsB,CAAC,CAAC2D,KAAK,CAAC,CAAC;MAEnF,MAAM8E,YAAY,GAAG1J,eAAe,CAAE;QACrCkG,KAAK,EAAEuD,OAAO;QACdnJ,aAAa,EAAEmG,WAAW;QAC1BqB,WAAW,EAAEpB,YAAY;QACzBnG,SAAS,EAAEE;MACZ,CAAE,CAAC;MAEH,IAAI,CAACyG,yBAAyB,CAACoB,SAAS,CAAE,IAAI,CAACtB,iBAAiB,CAACvE,GAAG,CAAEiH,YAAa,CAAE,CAAC;IAEvF;;IAEA;;IAEA,MAAMC,gBAAgB,GAAGvI,IAAI,CAAC,CAAC,CAACoG,IAAI,CAAE,kBAAmB,CAAC;IAC1D,MAAMoC,eAAe,GAAGxI,IAAI,CAAC,CAAC,CAACoG,IAAI,CAAE,iBAAkB,CAAC;IACxD,MAAMqC,wBAAwB,GAAGL,aAAa,CAAC/G,GAAG,CAAE,CAAC,GAAGC,IAAI,CAACC,EAAG,CAAC;IAEjE,IAAI,CAACgF,sBAAsB,CAAEgC,gBAAgB,EAAEC,eAAgB,CAAC;IAEhE,MAAME,eAAe,GAAGH,gBAAgB,CAAC7H,GAAG,CAAE8H,eAAgB,CAAC;IAE/D,MAAMG,OAAO,GAAG1J,YAAY,CAACoC,GAAG,CAAEqH,eAAe,CAACE,CAAC,CAACvE,GAAG,CAAEqE,eAAe,CAACG,CAAE,CAAC,CAACxE,GAAG,CAAEqE,eAAe,CAACvD,CAAE,CAAC,CAAChC,QAAQ,CAAC,CAAE,CAAC;IAElHoE,cAAc,CAACU,gBAAgB,CAACf,SAAS,CAAEiB,QAAQ,CAAC9G,GAAG,CAAEkH,gBAAiB,CAAE,CAAC;IAC7EhB,cAAc,CAACU,gBAAgB,CAACf,SAAS,CAAEsB,eAAe,CAACnH,GAAG,CAAEoH,wBAAyB,CAAE,CAAC;IAE5FlB,cAAc,CAACQ,eAAe,CAACb,SAAS,CAAEyB,OAAO,CAACtH,GAAG,CAAEoH,wBAAyB,CAAE,CAAC;EAEpF;EAEAK,gBAAgBA,CAAAC,KAAA,EAAyC;IAAA,IAAvC;MAAED,gBAAgB;MAAEvB;IAAe,CAAC,GAAAwB,KAAA;IAErD,MAAMjE,KAAK,GAAGnF,qBAAqB,CAACoF,GAAG,CAAElF,qBAAsB,CAAC,CAAC2D,KAAK,CAAC,CAAC,CAAC,CAAC;;IAE1E,MAAMwF,IAAI,GAAGlE,KAAK,CAACpE,GAAG,CAAEoI,gBAAiB,CAAC;IAC1C,MAAMG,KAAK,GAAG9J,SAAS,CAACkC,GAAG,CAAE,CAAE,IAAK,CAAC,CAAC8B,QAAQ,CAAC,CAAC,CAACpB,MAAM,CAAC,CAAC,CAACmH,IAAI,CAAC,CAAC;IAEhE,MAAMC,MAAM,GAAGL,gBAAgB,CAAClI,GAAG,CAAEoI,IAAI,CAACI,GAAG,CAAEH,KAAM,CAAC,CAAC9F,QAAQ,CAAC,CAAE,CAAC,CAACK,KAAK,CAAC,CAAC;IAE3E,IAAK,IAAI,CAACpE,SAAS,KAAK,IAAI,EAAG;MAE9B,IAAI,CAAC0G,yBAAyB,CAACuD,SAAS,CAAEP,gBAAiB,CAAC;IAE7D;IAEA,IAAK,IAAI,CAACxJ,KAAK,KAAK,IAAI,EAAG;MAE1B,IAAI,CAAC0G,qBAAqB,CAACqD,SAAS,CAAEP,gBAAiB,CAAC;IAEzD;IAEAvB,cAAc,CAACQ,eAAe,CAACsB,SAAS,CAAEP,gBAAiB,CAAC;IAC5DvB,cAAc,CAACU,gBAAgB,CAACoB,SAAS,CAAEF,MAAO,CAAC;EAEpD;EAEAG,MAAMA,CAAEC,OAAO,EAAG;IAEjB,MAAM;MAAEC;IAAc,CAAC,GAAGD,OAAO;IAEjC,IAAK,IAAI,CAACnK,SAAS,KAAK,IAAI,EAAG;MAE9B,MAAMiJ,OAAO,GAAGzI,8BAA8B,CAACmF,GAAG,CAAElF,qBAAsB,CAAC,CAAC2D,KAAK,CAAC,CAAC;MAEnF,MAAMiG,GAAG,GAAG5K,SAAS,CAAE;QACtBoE,KAAK,EAAEoF,OAAO;QACdtF,EAAE,EAAEsC,WAAW;QACfrC,GAAG,EAAEsC;MACN,CAAE,CAAC;MAEH,MAAMoE,cAAc,GAAGF,aAAa,CAACnI,GAAG,CAAEjC,SAAS,CAACiC,GAAG,CAAEoI,GAAI,CAAC,CAACtG,QAAQ,CAAC,CAAE,CAAC,CAACzC,GAAG,CAAE,IAAI,CAACmF,uBAAuB,CAACnF,GAAG,CAAE,IAAI,CAACoF,yBAA0B,CAAC,CAACzE,GAAG,CAAEjC,SAAU,CAAE,CAAC;MAEtKoK,aAAa,CAACG,MAAM,CAAED,cAAe,CAAC;IAEvC;IAEA,IAAK,IAAI,CAACpK,KAAK,KAAK,IAAI,EAAG;MAE1B,MAAMsK,eAAe,GAAGtK,KAAK,CAACsJ,CAAC,CAACvE,GAAG,CAAE/E,KAAK,CAACuJ,CAAE,CAAC,CAACxE,GAAG,CAAE/E,KAAK,CAAC6F,CAAE,CAAC,CAAC9D,GAAG,CAAE,KAAM,CAAC,CAAC8B,QAAQ,CAAC,CAAC;MACrF,MAAM0G,UAAU,GAAGL,aAAa,CAACnI,GAAG,CAAEuI,eAAgB,CAAC,CAAClJ,GAAG,CAAE,IAAI,CAACqF,mBAAmB,EAAE,IAAI,CAACC,qBAAsB,CAAC;MAEnHwD,aAAa,CAACG,MAAM,CAAEE,UAAW,CAAC;IAEnC;EAED;AAED;AAEA,eAAetE,qBAAqB"},"metadata":{},"sourceType":"module","externalDependencies":[]}