{"ast":null,"code":"import Node, { addNodeClass } from '../core/Node.js';\nimport { instancedBufferAttribute, instancedDynamicBufferAttribute } from './BufferAttributeNode.js';\nimport { normalLocal } from './NormalNode.js';\nimport { positionLocal } from './PositionNode.js';\nimport { nodeProxy, vec3, mat3, mat4 } from '../shadernode/ShaderNode.js';\nimport { DynamicDrawUsage, InstancedInterleavedBuffer } from 'three';\nclass InstanceNode extends Node {\n  constructor(instanceMesh) {\n    super('void');\n    this.instanceMesh = instanceMesh;\n    this.instanceMatrixNode = null;\n  }\n  setup( /*builder*/\n  ) {\n    let instanceMatrixNode = this.instanceMatrixNode;\n    if (instanceMatrixNode === null) {\n      const instanceMesh = this.instanceMesh;\n      const instanceAttribute = instanceMesh.instanceMatrix;\n      const buffer = new InstancedInterleavedBuffer(instanceAttribute.array, 16, 1);\n      const bufferFn = instanceAttribute.usage === DynamicDrawUsage ? instancedDynamicBufferAttribute : instancedBufferAttribute;\n      const instanceBuffers = [\n      // F.Signature -> bufferAttribute( array, type, stride, offset )\n      bufferFn(buffer, 'vec4', 16, 0), bufferFn(buffer, 'vec4', 16, 4), bufferFn(buffer, 'vec4', 16, 8), bufferFn(buffer, 'vec4', 16, 12)];\n      instanceMatrixNode = mat4(...instanceBuffers);\n      this.instanceMatrixNode = instanceMatrixNode;\n    }\n\n    // POSITION\n\n    const instancePosition = instanceMatrixNode.mul(positionLocal).xyz;\n\n    // NORMAL\n\n    const m = mat3(instanceMatrixNode[0].xyz, instanceMatrixNode[1].xyz, instanceMatrixNode[2].xyz);\n    const transformedNormal = normalLocal.div(vec3(m[0].dot(m[0]), m[1].dot(m[1]), m[2].dot(m[2])));\n    const instanceNormal = m.mul(transformedNormal).xyz;\n\n    // ASSIGNS\n\n    positionLocal.assign(instancePosition);\n    normalLocal.assign(instanceNormal);\n  }\n}\nexport default InstanceNode;\nexport const instance = nodeProxy(InstanceNode);\naddNodeClass('InstanceNode', InstanceNode);","map":{"version":3,"names":["Node","addNodeClass","instancedBufferAttribute","instancedDynamicBufferAttribute","normalLocal","positionLocal","nodeProxy","vec3","mat3","mat4","DynamicDrawUsage","InstancedInterleavedBuffer","InstanceNode","constructor","instanceMesh","instanceMatrixNode","setup","instanceAttribute","instanceMatrix","buffer","array","bufferFn","usage","instanceBuffers","instancePosition","mul","xyz","m","transformedNormal","div","dot","instanceNormal","assign","instance"],"sources":["/Users/vedant/node_modules/three/examples/jsm/nodes/accessors/InstanceNode.js"],"sourcesContent":["import Node, { addNodeClass } from '../core/Node.js';\nimport { instancedBufferAttribute, instancedDynamicBufferAttribute } from './BufferAttributeNode.js';\nimport { normalLocal } from './NormalNode.js';\nimport { positionLocal } from './PositionNode.js';\nimport { nodeProxy, vec3, mat3, mat4 } from '../shadernode/ShaderNode.js';\nimport { DynamicDrawUsage, InstancedInterleavedBuffer } from 'three';\n\nclass InstanceNode extends Node {\n\n\tconstructor( instanceMesh ) {\n\n\t\tsuper( 'void' );\n\n\t\tthis.instanceMesh = instanceMesh;\n\n\t\tthis.instanceMatrixNode = null;\n\n\t}\n\n\tsetup( /*builder*/ ) {\n\n\t\tlet instanceMatrixNode = this.instanceMatrixNode;\n\n\t\tif ( instanceMatrixNode === null ) {\n\n\t\t\tconst instanceMesh = this.instanceMesh;\n\t\t\tconst instanceAttribute = instanceMesh.instanceMatrix;\n\t\t\tconst buffer = new InstancedInterleavedBuffer( instanceAttribute.array, 16, 1 );\n\n\t\t\tconst bufferFn = instanceAttribute.usage === DynamicDrawUsage ? instancedDynamicBufferAttribute : instancedBufferAttribute;\n\n\t\t\tconst instanceBuffers = [\n\t\t\t\t// F.Signature -> bufferAttribute( array, type, stride, offset )\n\t\t\t\tbufferFn( buffer, 'vec4', 16, 0 ),\n\t\t\t\tbufferFn( buffer, 'vec4', 16, 4 ),\n\t\t\t\tbufferFn( buffer, 'vec4', 16, 8 ),\n\t\t\t\tbufferFn( buffer, 'vec4', 16, 12 )\n\t\t\t];\n\n\t\t\tinstanceMatrixNode = mat4( ...instanceBuffers );\n\n\t\t\tthis.instanceMatrixNode = instanceMatrixNode;\n\n\t\t}\n\n\t\t// POSITION\n\n\t\tconst instancePosition = instanceMatrixNode.mul( positionLocal ).xyz;\n\n\t\t// NORMAL\n\n\t\tconst m = mat3( instanceMatrixNode[ 0 ].xyz, instanceMatrixNode[ 1 ].xyz, instanceMatrixNode[ 2 ].xyz );\n\n\t\tconst transformedNormal = normalLocal.div( vec3( m[ 0 ].dot( m[ 0 ] ), m[ 1 ].dot( m[ 1 ] ), m[ 2 ].dot( m[ 2 ] ) ) );\n\n\t\tconst instanceNormal = m.mul( transformedNormal ).xyz;\n\n\t\t// ASSIGNS\n\n\t\tpositionLocal.assign( instancePosition );\n\t\tnormalLocal.assign( instanceNormal );\n\n\t}\n\n}\n\nexport default InstanceNode;\n\nexport const instance = nodeProxy( InstanceNode );\n\naddNodeClass( 'InstanceNode', InstanceNode );\n"],"mappings":"AAAA,OAAOA,IAAI,IAAIC,YAAY,QAAQ,iBAAiB;AACpD,SAASC,wBAAwB,EAAEC,+BAA+B,QAAQ,0BAA0B;AACpG,SAASC,WAAW,QAAQ,iBAAiB;AAC7C,SAASC,aAAa,QAAQ,mBAAmB;AACjD,SAASC,SAAS,EAAEC,IAAI,EAAEC,IAAI,EAAEC,IAAI,QAAQ,6BAA6B;AACzE,SAASC,gBAAgB,EAAEC,0BAA0B,QAAQ,OAAO;AAEpE,MAAMC,YAAY,SAASZ,IAAI,CAAC;EAE/Ba,WAAWA,CAAEC,YAAY,EAAG;IAE3B,KAAK,CAAE,MAAO,CAAC;IAEf,IAAI,CAACA,YAAY,GAAGA,YAAY;IAEhC,IAAI,CAACC,kBAAkB,GAAG,IAAI;EAE/B;EAEAC,KAAKA,CAAA,CAAE;EAAA,EAAc;IAEpB,IAAID,kBAAkB,GAAG,IAAI,CAACA,kBAAkB;IAEhD,IAAKA,kBAAkB,KAAK,IAAI,EAAG;MAElC,MAAMD,YAAY,GAAG,IAAI,CAACA,YAAY;MACtC,MAAMG,iBAAiB,GAAGH,YAAY,CAACI,cAAc;MACrD,MAAMC,MAAM,GAAG,IAAIR,0BAA0B,CAAEM,iBAAiB,CAACG,KAAK,EAAE,EAAE,EAAE,CAAE,CAAC;MAE/E,MAAMC,QAAQ,GAAGJ,iBAAiB,CAACK,KAAK,KAAKZ,gBAAgB,GAAGP,+BAA+B,GAAGD,wBAAwB;MAE1H,MAAMqB,eAAe,GAAG;MACvB;MACAF,QAAQ,CAAEF,MAAM,EAAE,MAAM,EAAE,EAAE,EAAE,CAAE,CAAC,EACjCE,QAAQ,CAAEF,MAAM,EAAE,MAAM,EAAE,EAAE,EAAE,CAAE,CAAC,EACjCE,QAAQ,CAAEF,MAAM,EAAE,MAAM,EAAE,EAAE,EAAE,CAAE,CAAC,EACjCE,QAAQ,CAAEF,MAAM,EAAE,MAAM,EAAE,EAAE,EAAE,EAAG,CAAC,CAClC;MAEDJ,kBAAkB,GAAGN,IAAI,CAAE,GAAGc,eAAgB,CAAC;MAE/C,IAAI,CAACR,kBAAkB,GAAGA,kBAAkB;IAE7C;;IAEA;;IAEA,MAAMS,gBAAgB,GAAGT,kBAAkB,CAACU,GAAG,CAAEpB,aAAc,CAAC,CAACqB,GAAG;;IAEpE;;IAEA,MAAMC,CAAC,GAAGnB,IAAI,CAAEO,kBAAkB,CAAE,CAAC,CAAE,CAACW,GAAG,EAAEX,kBAAkB,CAAE,CAAC,CAAE,CAACW,GAAG,EAAEX,kBAAkB,CAAE,CAAC,CAAE,CAACW,GAAI,CAAC;IAEvG,MAAME,iBAAiB,GAAGxB,WAAW,CAACyB,GAAG,CAAEtB,IAAI,CAAEoB,CAAC,CAAE,CAAC,CAAE,CAACG,GAAG,CAAEH,CAAC,CAAE,CAAC,CAAG,CAAC,EAAEA,CAAC,CAAE,CAAC,CAAE,CAACG,GAAG,CAAEH,CAAC,CAAE,CAAC,CAAG,CAAC,EAAEA,CAAC,CAAE,CAAC,CAAE,CAACG,GAAG,CAAEH,CAAC,CAAE,CAAC,CAAG,CAAE,CAAE,CAAC;IAErH,MAAMI,cAAc,GAAGJ,CAAC,CAACF,GAAG,CAAEG,iBAAkB,CAAC,CAACF,GAAG;;IAErD;;IAEArB,aAAa,CAAC2B,MAAM,CAAER,gBAAiB,CAAC;IACxCpB,WAAW,CAAC4B,MAAM,CAAED,cAAe,CAAC;EAErC;AAED;AAEA,eAAenB,YAAY;AAE3B,OAAO,MAAMqB,QAAQ,GAAG3B,SAAS,CAAEM,YAAa,CAAC;AAEjDX,YAAY,CAAE,cAAc,EAAEW,YAAa,CAAC"},"metadata":{},"sourceType":"module","externalDependencies":[]}